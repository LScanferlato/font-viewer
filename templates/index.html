<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Font Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f4f4f4; margin:0; }
    header { text-align:center; margin-bottom:30px; }
    main { max-width:800px; margin:0 auto; }
    .font-preview { background:#fff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:20px; margin-bottom:20px; }
    .font-name { font-weight:bold; font-size:1.1rem; margin-bottom:5px; }
    .font-sample { font-size:24px; margin-top:10px; }
    .controls { margin-top:10px; display:flex; gap:10px; }
    .controls button { background:#007bff; color:#fff; border:none; border-radius:5px; padding:8px 14px; cursor:pointer; font-size:1rem; }
    .controls button:hover { background:#0056b3; }
    .search-bar { display:flex; gap:10px; margin-bottom:30px; justify-content:center; }
    .search-bar input[type="text"] { padding:10px; width:60%; border:1px solid #ccc; border-radius:4px; font-size:1rem; }
    .search-bar button { padding:10px 18px; }
    @media (max-width:600px){ main{padding:0 5px;} .search-bar input[type="text"]{width:100%;} }

    /* Barra di progresso */
    .progress-container { width:100%; background:#ddd; border-radius:8px; overflow:hidden; margin:20px 0; height:20px; }
    .progress-bar { height:100%; width:0%; background:#28a745; text-align:center; color:#fff; font-size:0.8rem; transition:width 0.3s ease; }
  </style>
</head>
<body>
  <header><h1>Font Viewer</h1></header>
  <main>
    <!-- Ricerca lato server -->
    <form method="get" action="/" class="search-bar">
      <input type="text" name="query" placeholder="Cerca font per nomeâ€¦" value="{{ query|e }}">
      <button type="submit">Cerca</button>
    </form>

    <!-- Testo anteprima -->
    <div style="margin-bottom:20px;">
      <label for="previewText">Testo di anteprima:</label>
      <input type="text" id="previewText" value="Anteprima Font" oninput="updatePreviewText()" style="width:100%;padding:10px;margin-bottom:10px;">
    </div>

    <!-- Dimensione font -->
    <div style="margin-bottom:30px;">
      <label for="fontSize">Dimensione del font:</label>
      <input type="range" id="fontSize" min="12" max="72" value="24" oninput="updateFontSize()" style="width:100%;">
      <span id="fontSizeValue">24px</span>
    </div>

    <!-- Barra di progresso -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar">0%</div>
    </div>

    <!-- Risultati -->
    <section id="fontResults" aria-label="Risultati font"></section>
    <p style="text-align:center;margin-top:30px;" id="fontCount"></p>
  </main>

  <script>
    let currentIndex = 0;
    const batchSize = 50;
    let totalFonts = {{ total_fonts }};
    let loading = false;

    async function fetchFonts() {
      if (loading) return;
      loading = true;

      const res = await fetch(`/api/fonts?start=${currentIndex}&limit=${batchSize}`);
      const data = await res.json();

      const container = document.getElementById('fontResults');
      data.fonts.forEach((font, i) => {
        const idx = currentIndex + i + 1;
        const div = document.createElement('div');
        div.className = 'font-preview';
        div.innerHTML = `
          <p class="font-name">${font}</p>
          <style>@font-face { font-family: 'font${idx}'; src: url("/fonts/${font}"); }</style>
          <p class="font-sample" id="sample${idx}" style="font-family:'font${idx}';">Anteprima Font</p>
          <div class="controls">
            <a href="/fonts/${font}" download><button type="button">Scarica Font</button></a>
            <button onclick="downloadImage('sample${idx}')" type="button">Scarica Immagine</button>
          </div>`;
        container.appendChild(div);
      });

      currentIndex += batchSize;
      updateProgress();
      document.getElementById('fontCount').textContent = `Totale font caricati: ${currentIndex} / ${totalFonts}`;
      loading = false;
    }

    function updateProgress() {
      const percent = totalFonts === 0 ? 0 : Math.min((currentIndex / totalFonts) * 100, 100).toFixed(1);
      const bar = document.getElementById('progressBar');
      bar.style.width = percent + '%';
      bar.textContent = percent + '%';
    }

    function updatePreviewText() {
      const text = document.getElementById('previewText').value;
      document.querySelectorAll('.font-sample').forEach(el => el.textContent = text);
    }

    function updateFontSize() {
      const size = document.getElementById('fontSize').value + 'px';
      document.getElementById('fontSizeValue').textContent = size;
      document.querySelectorAll('.font-sample').forEach(el => el.style.fontSize = size);
    }

    function downloadImage(elementId) {
      const element = document.getElementById(elementId);
      html2canvas(element, {backgroundColor:null}).then(canvas => {
        const link = document.createElement('a');
        link.download = elementId + '.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    // Lazy loading con IntersectionObserver
    function setupLazyLoading() {
      const sentinel = document.createElement('div');
      sentinel.id = 'sentinel';
      document.querySelector('main').appendChild(sentinel);

      const observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) {
          fetchFonts();
        }
      });
      observer.observe(sentinel);
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchFonts();
      updateFontSize();
      updatePreviewText();
      setupLazyLoading();
    });
  </script>
</body>
</html>
